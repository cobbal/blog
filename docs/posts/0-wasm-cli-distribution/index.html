<!DOCTYPE html>
<html lang="en">
<head profile="http://www.w3.org/2005/10/profile">
    <meta charset="UTF-8">
    <meta name="description" content="blog.cobbal.com">
    <meta name="author" content="Andrew Cobb">
    <meta name=viewport content="width=device-width, initial-scale=1">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Cross-platform binaries with swift, wasm, and NPM">
    <meta name="twitter:description" content="">
    
    <title>Cross-platform binaries with swift, wasm, and NPM</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/syntax.css">
</head>
<body>
<header>
    <nav>
        <a id="beacon" href="/">
            <div id="home-text"> Home</div>
        </a>
    </nav>

    <div class="right-sidebar">
        <a class="ext-link" href="https://github.com/cobbal/blog">
            <img src="/images/github-logo.svg" alt="Github Source" class="light-inverted"/>
        </a>
        <a class="ext-link" href="https://bsky.app/profile/cobbal.bsky.social">
            <img src="/images/bluesky-logo.svg" alt="Bluesky Profile" class="light-inverted"/>
        </a>
        <a class="ext-link" href="https://mstdn.social/@cobbal">
            <img src="/images/mastodon-logo.svg" alt="Mastodon Profile" class="light-inverted"/>
        </a>
        <a class="ext-link" id="theme-button">
            <img src="/images/white-sun-behind-cloud-noto-emoji-bold.svg" alt="Toggle light mode" class="light-inverted"/>
        </a>
    </div>
</header>

<div id="page">
    <div class="wrapper">
        <div class="masthead">
            <span class="title">
                Cross-platform binaries with swift, wasm, and NPM
            </span>
            <br>

            <br>
            <span class="byline">by Andrew Cobb</span>
            <br>
            <span class="date">Jun 24, 2025</span>
            <br>
            <div class="metadata">
            </div>
            <div class="tags">
                <span class="tag">[wasm]</span>
                <span class="tag">[swift]</span>
            </div>
        </div>
    </div>
    <article class="post">
        <h2 id="why">Why</h2>
<p>Distributing a cross-platform binary is a pain. Mostly because of
windows. Linux isn't helping much either. And macOS isn't great.
Dependencies and/or docker are a pain to manage.</p>
<h2 id="who">Who</h2>
<ul>
<li>swift</li>
<li>wasm</li>
<li>node.js / NPM</li>
</ul>
<h2 id="how">How</h2>
<ol>
<li>Create a command-line program</li>
</ol>
<p>Package.swift:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode swift"><code class="sourceCode swift"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// swift-tools-version: 6.0</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">PackageDescription</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">package</span> <span class="op">=</span> Package<span class="op">(</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">:</span> <span class="st">&quot;orb&quot;</span><span class="op">,</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    targets<span class="op">:</span> <span class="op">[</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>executableTarget<span class="op">(</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>            name<span class="op">:</span> <span class="st">&quot;orb&quot;</span><span class="op">,</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>            path<span class="op">:</span> <span class="st">&quot;.&quot;</span><span class="op">,</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>            sources<span class="op">:</span> <span class="op">[</span><span class="st">&quot;orb.swift&quot;</span><span class="op">]</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">]</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span></code></pre></div>
<p>And the CLI "utility" itself in orb.swift:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode swift"><code class="sourceCode swift"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">asciiImage</span><span class="op">(</span><span class="va">_</span> <span class="va">pixelAt</span><span class="op">:</span> <span class="op">(</span><span class="dt">Double</span><span class="op">,</span> <span class="dt">Double</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="dt">Double</span><span class="op">)</span> -&gt; <span class="fu">String</span> <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">gradient</span> <span class="op">=</span> <span class="st">&quot;@%#*+=-:. &quot;</span><span class="op">.</span>map <span class="op">{</span> <span class="st">&quot;</span><span class="er">\(</span><span class="ss">$</span><span class="st">0)&quot;</span> <span class="op">}</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="op">(</span><span class="fl">0.</span><span class="op">.&lt;</span><span class="dv">50</span><span class="op">).</span>map <span class="op">{</span> y <span class="cf">in</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span><span class="fl">0.</span><span class="op">.&lt;</span><span class="dv">100</span><span class="op">).</span>map <span class="op">{</span> x <span class="cf">in</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">pixel</span> <span class="op">=</span> pixelAt<span class="op">(</span>Double<span class="op">(</span>x<span class="op">)</span> <span class="op">/</span> <span class="dv">50</span> <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> Double<span class="op">(</span>y<span class="op">)</span> <span class="op">/</span> <span class="dv">25</span> <span class="op">-</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">iPixel</span> <span class="op">=</span> Int<span class="op">(</span>pixel <span class="op">*</span> Double<span class="op">(</span>gradient<span class="op">.</span>count<span class="op">))</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> gradient<span class="op">[</span>max<span class="op">(</span><span class="dv">0</span><span class="op">,</span> min<span class="op">(</span>iPixel<span class="op">,</span> gradient<span class="op">.</span>count<span class="op">))]</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">}.</span>joined<span class="op">()</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}.</span>joined<span class="op">(</span>separator<span class="op">:</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">theOrb</span> <span class="op">=</span> asciiImage <span class="op">{</span> x<span class="op">,</span> y <span class="cf">in</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">z</span> <span class="op">=</span> <span class="op">(</span><span class="dv">1</span> <span class="op">-</span> <span class="op">(</span>x <span class="op">*</span> x <span class="op">+</span> y <span class="op">*</span> y<span class="op">)).</span>squareRoot<span class="op">()</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> z<span class="op">.</span>isNaN <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="op">(</span><span class="dv">2</span> <span class="op">*</span> x <span class="op">-</span> <span class="dv">3</span> <span class="op">*</span> y <span class="op">+</span> <span class="dv">6</span> <span class="op">*</span> z<span class="op">)</span> <span class="op">/</span> <span class="dv">7</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>print<span class="op">(</span>theOrb<span class="op">)</span></span></code></pre></div>
<ol>
<li>Install the
<a href="https://book.swiftwasm.org/getting-started/setup.html">swift-wasm
toolchain</a></li>
<li>Compile for wasm (I'm using swift and swift-wasm 6.1):</li>
</ol>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">swiftly</span> run +6.1 swift build <span class="at">--swift-sdk</span> wasm32-unknown-wasi</span></code></pre></div>
<ol>
<li>Grab the binary at .build/wasm32-unknown-wasi/debug/orb.wasm and
construct a node package</li>
</ol>
<p>package.json:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;wasm-orb&quot;</span><span class="fu">,</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;0.0.1&quot;</span><span class="fu">,</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;description&quot;</span><span class="fu">:</span> <span class="st">&quot;The Orb&quot;</span><span class="fu">,</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;files&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;orb.wasm&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;bin&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;orb&quot;</span><span class="fu">:</span> <span class="st">&quot;orb.js&quot;</span> <span class="fu">},</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;engines&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;node&quot;</span><span class="fu">:</span> <span class="st">&quot;&gt;=19&quot;</span> <span class="fu">}</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>orb.mjs:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env node --disable-warning=ExperimentalWarning</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Adapted from sample code at https://nodejs.org/api/wasi.html</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { readFile } <span class="im">from</span> <span class="st">&#39;node:fs/promises&#39;</span><span class="op">;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { WASI } <span class="im">from</span> <span class="st">&#39;node:wasi&#39;</span><span class="op">;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { argv<span class="op">,</span> env<span class="op">,</span> cwd } <span class="im">from</span> <span class="st">&#39;node:process&#39;</span><span class="op">;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> wasi <span class="op">=</span> <span class="kw">new</span> <span class="fu">WASI</span>({</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">version</span><span class="op">:</span> <span class="st">&#39;preview1&#39;</span><span class="op">,</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">args</span><span class="op">:</span> argv<span class="op">.</span><span class="fu">slice</span>(<span class="dv">1</span>)<span class="op">,</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">env</span><span class="op">:</span> {</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span>env<span class="op">,</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">PWD</span><span class="op">:</span> <span class="fu">cwd</span>()<span class="op">,</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">preopens</span><span class="op">:</span> { <span class="st">&quot;/&quot;</span><span class="op">:</span> <span class="st">&quot;/&quot;</span> }<span class="op">,</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> wasm <span class="op">=</span> <span class="cf">await</span> WebAssembly<span class="op">.</span><span class="fu">compile</span>(</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> <span class="fu">readFile</span>(<span class="kw">new</span> <span class="fu">URL</span>(<span class="st">&#39;./orb.wasm&#39;</span><span class="op">,</span> <span class="im">import</span><span class="op">.</span><span class="at">meta</span><span class="op">.</span><span class="at">url</span>))<span class="op">,</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> instance <span class="op">=</span> <span class="cf">await</span> WebAssembly<span class="op">.</span><span class="fu">instantiate</span>(wasm<span class="op">,</span> wasi<span class="op">.</span><span class="fu">getImportObject</span>())<span class="op">;</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>wasi<span class="op">.</span><span class="fu">start</span>(instance)<span class="op">;</span></span></code></pre></div>
<ol>
<li>Invoke the orb</li>
</ol>
<pre><code>$ npm exec orb
                                                  +
                                    *+++=====------------------=+
                               *+++====-------:::::::::::::::::::----=
                           *+++====------:::::::::::::........:::::::::---
                       #**++====------:::::::::.......................:::::--=
                    %**+++====-----::::::::...............................::::--
                  #**+++====-----::::::::.............             ..........::::--
                #***+++===------:::::::...........                      ........:::--
              ##**+++====-----:::::::..........                            .......:::--
            %##**+++====-----:::::::..........                               .......:::-=
          @%#***+++====-----:::::::.........                                   ......:::--+
         %%#***+++====------::::::..........                                     .....::::-=
        %%##**++++====-----:::::::.........                                       .....::::-=
       %%##***+++====------::::::..........                                        .....::::-=
      @%##***++++====-----:::::::.........                                         ......::::-=
     @%%##***+++=====-----:::::::..........                                         ......:::--=
    @%%##***++++=====-----:::::::..........                                         ......::::--=
   @@%%##***++++=====-----::::::::.........                                         .......:::--==
  @@@%%##***++++=====------:::::::..........                                        .......::::--=*
  @@%%###***++++=====------::::::::..........                                       .......::::--==
  @@%%###****++++=====------::::::::...........                                    .......:::::--==
 @@@%%###****++++=====------:::::::::...........                                  ........:::::--==+
 @@@%%%###***+++++=====------:::::::::............                               .........::::---==+
 @@@%%%###****++++======------:::::::::..............                          ..........:::::---==+
 @@@@%%###****+++++======------::::::::::...............                    ............:::::----==+
@@@@@%%%###****+++++======-------:::::::::....................        .................::::::---===+
 @@@@@%%####****+++++======-------:::::::::::........................................:::::::----==++
 @@@@@%%%###*****+++++======--------:::::::::::....................................::::::::----===++
 @@@@@@%%%###*****+++++=======--------:::::::::::::.............................:::::::::-----===++*
 @@@@@@%%%%###*****+++++=======---------:::::::::::::::.....................::::::::::::-----====++*
  @@@@@@%%%%###*****++++++=======----------:::::::::::::::::::::::::::::::::::::::::::------====++*
  @@@@@@@%%%%####*****++++++=======-----------:::::::::::::::::::::::::::::::::::::-------====+++*#
  @@@@@@@@%%%%####*****+++++++========------------::::::::::::::::::::::::::::::--------=====+++**%
   @@@@@@@@%%%%#####*****+++++++=========---------------:::::::::::::::::::-----------======+++**#
    @@@@@@@@@%%%%####******+++++++==========---------------------------------------=======++++**#
     @@@@@@@@@%%%%#####******++++++++===========--------------------------------========++++**##
      @@@@@@@@@@%%%%#####******+++++++++==============--------------------===========+++++***##
       @@@@@@@@@@%%%%%#####*******++++++++++======================================++++++***##%
        @@@@@@@@@@@%%%%%######*******++++++++++++============================++++++++****###%
         @@@@@@@@@@@@%%%%%#######********+++++++++++++++++===========+++++++++++++*****###%@
           @@@@@@@@@@@@@%%%%%#######**********++++++++++++++++++++++++++++++++******####%%
            @@@@@@@@@@@@@@%%%%%%########**************+++++++++++++++++**********####%%%@
              @@@@@@@@@@@@@@@%%%%%%%#########********************************#####%%%@@
                @@@@@@@@@@@@@@@@@%%%%%%%#############****************##########%%%%@@
                  @@@@@@@@@@@@@@@@@@@%%%%%%%%%###########################%%%%%%@@@@
                    @@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@@
                       @@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%%%%@@@@@@@@@@@
                           @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
                               @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
                                    @@@@@@@@@@@@@@@@@@@@@@@@@@@@@</code></pre>
<h2 id="possible-next-steps">Possible next steps</h2>
<p>Theoretically, this could be used to distribute non-orb software as
well, but I'm not sure why anyone would want to.</p>
<h2 id="limitations">Limitations</h2>
<ul>
<li>File system is a little janky: TODO: use PWD env var
<ul>
<li>wasi is unix-like. It may struggle with windows paths passed into
the program.</li>
</ul></li>
<li>No networking, no threads, no libdispatch</li>
<li>Swift package and dependencies must compile to wasm. Many do,
including C/C++ dependencies, many do not.</li>
<li>This is not a secure sandbox. Binaries distributed this way have
access to the system (both a feature and a limitation). See <a
href="TODO">node's documentation</a></li>
<li>The binaries are large-ish. This can be mitigated slightly by using
<a href="TODO">wasm-opt</a> and compiling in release mode</li>
<li>Debugging support is... very limited. Debug a native binary
instead.</li>
</ul>

        <br>
        <br>
    </article>
</div>

<footer>
    <p>Written by a human without AI.</p>
    <p>Website built using <a href="https://github.com/ChrisPenner/slick">slick</a>.</p>
    <p>All code is licensed under <a href="https://opensource.org/license/bsd-3-clause">BSD-3-Clause</a> unless cited as
        an external source.</p>
    <p>All prose is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY 4.0</a> unless cited as
        an external source.</p>
</footer>

<link href='https://fonts.googleapis.com/css?family=Quicksand:300,400' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
<script src="/js/main.js"></script>
</body>
</html>
